<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sn√∂kanon Prognos + Karta</title>
    <meta name="theme-color" content="#0f172a">
    <!-- Chart.js f√∂r grafer -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Leaflet f√∂r Karta -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #1e293b; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        /* Header layout */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { font-size: 1.1rem; margin: 0; color: #e2e8f0; }
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; padding: 0; }
        .controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        button.time-btn { background-color: #334155; border: 1px solid #475569; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s; font-size: 0.8rem; }
        button.time-btn:active, button.time-btn.active { background-color: #3b82f6; border-color: #3b82f6; }
        .chart-container { flex-grow: 1; position: relative; min-height: 250px; background: #0f172a; border-radius: 12px; padding: 10px; border: 1px solid #334155; }
        .legend { font-size: 0.75rem; text-align: center; margin-top: 5px; color: #94a3b8; }
        /* MAP MODAL STYLES */
        #mapModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #1e293b; width: 100%; max-width: 500px; height: 80%; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #475569; }
        #map { flex-grow: 1; width: 100%; }
        .modal-header { padding: 15px; text-align: center; background: #0f172a; }
        .modal-footer { padding: 15px; display: flex; gap: 10px; justify-content: center; background: #0f172a; }
        .save-btn { background-color: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .cancel-btn { background-color: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .location-label { font-size: 0.8rem; color: #cbd5e1; margin-bottom: 5px; display: block;}

        /* Loading overlay */
        #loadingOverlay { display: none; position: absolute; inset: 0; background: rgba(2,6,23,0.6); z-index: 200; align-items: center; justify-content: center; border-radius: 12px; }
        .spinner { border: 4px solid rgba(255,255,255,0.08); border-top: 4px solid #3b82f6; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loadingText { color: #e2e8f0; font-size: 0.95rem; }
        .error { color: #fecaca; font-size: 0.9rem; text-align: center; margin-top: 8px; }
        /* Icon buttons */
        .icon-btn { background:#0f172a; border:1px solid #334155; color:#e2e8f0; padding:6px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
        .icon-btn:hover { background:#0b1220; }
        .search-result { padding:8px; border-radius:8px; cursor:pointer; color:#e2e8f0; }
        .search-result:hover { background:#0b1220; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <h1>‚ùÑÔ∏è Sn√∂prognos</h1>
        <button class="settings-btn" onclick="openMap()" title="√Ñndra plats" aria-label="√Ñndra plats">üìç</button>
    </div>
    <span id="locationDisplay" class="location-label">Plats: Laddar...</span>
        <div style="display:inline-flex; align-items:center; gap:8px;">
            <select id="favoritesSelect" style="background:#0f172a; color:#e2e8f0; border:1px solid #334155; padding:6px; border-radius:6px;"></select>
            <button id="gotoFavBtn" class="icon-btn" title="G√• till favorit" aria-label="G√• till favorit">
                <!-- arrow icon -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
            <button id="editFavBtn" class="icon-btn" title="Redigera favorit" aria-label="Redigera favorit">
                <!-- pencil icon -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path></svg>
            </button>
            <button id="delFavBtn" class="icon-btn" title="Ta bort favorit" aria-label="Ta bort favorit">
                <!-- trash icon -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
            </button>
        </div>

    <!-- CONTROLS -->
    <div class="controls">
        <button onclick="setRange(24, this)" class="time-btn">24h</button>
        <button onclick="setRange(72, this)" class="time-btn">3 Dygn</button>
        <button onclick="setRange(120, this)" class="time-btn">5 Dygn</button>
        <button onclick="setRange(240, this)" class="time-btn active">10 Dygn</button>
    </div>

    <!-- CHART -->
    <div class="chart-container">
        <div id="loadingOverlay"><div style="display:flex;align-items:center"><div class="spinner"></div><div class="loadingText">Laddar data‚Ä¶</div></div></div>
        <canvas id="snowChart"></canvas>
    </div>
    <div class="legend">Zooma: Nyp ‚Ä¢ R√∂d: Varmt ‚Ä¢ Bl√•: Sn√∂produktivt (Wet-bulb &lt; -2.5)</div>
    <div id="errorMsg" class="error" role="status" aria-live="polite"></div>

    <!-- MAP MODAL (Hidden by default) -->
    <div id="mapModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>V√§lj din Sn√∂kanonsanl√§ggning</h3>
                <p style="font-size: 0.8rem; color: #94a3b8; margin:0;">Dra mark√∂ren till sn√∂systemet</p>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <input id="mapSearch" placeholder="S√∂k plats eller adress" style="flex:1; background:#0b1220; color:#e2e8f0; border:1px solid #334155; padding:6px 8px; border-radius:8px;" aria-label="S√∂k plats" />
                    <button id="mapSearchBtn" class="icon-btn" title="S√∂k" aria-label="S√∂k">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e2e8f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </div>
                <div id="searchResults" style="margin-top:8px; max-height:140px; overflow:auto; display:none; border-top:1px solid #1f2937; padding-top:8px;"></div>
                <div id="favoriteChips" style="margin-top:8px; display:flex; gap:6px; overflow:auto; padding-bottom:6px;"></div>
            </div>
            <div id="map"></div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeMap()">Avbryt</button>
                <button class="save-btn" onclick="saveLocation()">Spara Plats</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLER ---
        // Standardv√§rden (Sparbankssp√•ret) om inget √§r sparat
        let currentLat = localStorage.getItem('snowLat') ? parseFloat(localStorage.getItem('snowLat')) : 58.503524076883366;
        let currentLon = localStorage.getItem('snowLon') ? parseFloat(localStorage.getItem('snowLon')) : 13.087781307969978;
        let currentName = localStorage.getItem('snowName') ? localStorage.getItem('snowName') : 'Sparbankssp√•ret';
        let chartInstance = null;
        let weatherData = [];
        let mapInstance = null;
        let markerInstance = null;

        updateLocationText();

        // MAP LOGIC
        function openMap() {
            document.getElementById('mapModal').style.display = 'flex';
            if (!mapInstance) {
                mapInstance = L.map('map').setView([currentLat, currentLon], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(mapInstance);
                markerInstance = L.marker([currentLat, currentLon], {draggable: true}).addTo(mapInstance);
                mapInstance.on('click', function(e) { markerInstance.setLatLng(e.latlng); });
            } else {
                mapInstance.invalidateSize();
                mapInstance.setView([currentLat, currentLon], 13);
                markerInstance.setLatLng([currentLat, currentLon]);
            }
        }

        function closeMap() { document.getElementById('mapModal').style.display = 'none'; }

        function saveLocation() {
            const pos = markerInstance.getLatLng();
            currentLat = pos.lat; currentLon = pos.lng;
            // Ask the user if they want to save as favorite
            const want = window.confirm('Vill du spara denna plats som favorit?');
            if (want) {
                const name = window.prompt('Ange namn f√∂r favoriten:', currentName || 'Favorit');
                if (name && name.trim().length) {
                    currentName = name.trim();
                    saveFavorite(currentName, currentLat, currentLon);
                }
            }

            // Persist coords and name
            localStorage.setItem('snowLat', currentLat);
            localStorage.setItem('snowLon', currentLon);
            localStorage.setItem('snowName', currentName);

            // Update marker / map so we stay at the saved pos
            if (markerInstance) {
                markerInstance.setLatLng([currentLat, currentLon]);
            }
            if (mapInstance) {
                mapInstance.setView([currentLat, currentLon], mapInstance.getZoom() || 13);
            }

            updateLocationText(); closeMap(); fetchData();
        }

        // Favorites management
        function saveFavorite(name, lat, lon) {
            const list = JSON.parse(localStorage.getItem('snowFavorites') || '[]');
            // avoid duplicate names: replace if same name
            const idx = list.findIndex(f => f.name === name);
            const item = { name, lat, lon };
            if (idx >= 0) list[idx] = item; else list.push(item);
            localStorage.setItem('snowFavorites', JSON.stringify(list));
            populateFavorites();
        }

        function populateFavorites() {
            const sel = document.getElementById('favoritesSelect');
            sel.innerHTML = '';
            const list = JSON.parse(localStorage.getItem('snowFavorites') || '[]');
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.text = '‚Äî V√§lj favorit ‚Äî';
            sel.appendChild(emptyOpt);
            list.forEach((f, i) => {
                const opt = document.createElement('option');
                opt.value = i.toString();
                opt.text = `${f.name} (${f.lat.toFixed(3)}, ${f.lon.toFixed(3)})`;
                sel.appendChild(opt);
            });

            // preselect current if it matches a favorite
            const curIdx = list.findIndex(f => Math.abs(f.lat - currentLat) < 1e-6 && Math.abs(f.lon - currentLon) < 1e-6);
            if (curIdx >= 0) sel.value = curIdx.toString(); else sel.value = '';
            // update chips in modal
            const chips = document.getElementById('favoriteChips');
            chips.innerHTML = '';
            list.forEach((f, i) => {
                const btn = document.createElement('button');
                btn.textContent = f.name;
                btn.style.padding = '6px 8px';
                btn.style.background = '#111827';
                btn.style.color = '#e2e8f0';
                btn.style.border = '1px solid #334155';
                btn.style.borderRadius = '8px';
                btn.style.cursor = 'pointer';
                btn.onclick = () => {
                    markerInstance.setLatLng([f.lat, f.lon]);
                    mapInstance.setView([f.lat, f.lon], 13);
                    currentLat = f.lat; currentLon = f.lon; currentName = f.name;
                    localStorage.setItem('snowLat', currentLat); localStorage.setItem('snowLon', currentLon); localStorage.setItem('snowName', currentName);
                    updateLocationText();
                };
                chips.appendChild(btn);
            });
        }

        // ensure default favorite exists
        function ensureDefaultFavorite() {
            const list = JSON.parse(localStorage.getItem('snowFavorites') || '[]');
            const found = list.some(f => Math.abs(f.lat - currentLat) < 1e-6 && Math.abs(f.lon - currentLon) < 1e-6);
            if (!found) {
                list.unshift({ name: currentName || 'Sparbankssp√•ret', lat: currentLat, lon: currentLon });
                localStorage.setItem('snowFavorites', JSON.stringify(list));
            }
        }

        document.getElementById('gotoFavBtn').addEventListener('click', () => {
            const sel = document.getElementById('favoritesSelect');
            const idx = sel.value;
            if (!idx) return;
            const list = JSON.parse(localStorage.getItem('snowFavorites') || '[]');
            const f = list[parseInt(idx)];
            if (!f) return;
            currentLat = f.lat; currentLon = f.lon; currentName = f.name;
            localStorage.setItem('snowLat', currentLat); localStorage.setItem('snowLon', currentLon); localStorage.setItem('snowName', currentName);
            updateLocationText(); fetchData();
        });

        // Edit and delete favorite
        document.getElementById('editFavBtn').addEventListener('click', () => {
            const sel = document.getElementById('favoritesSelect');
            const idx = sel.value;
            if (!idx) return alert('V√§lj en favorit att redigera');
            const list = JSON.parse(localStorage.getItem('snowFavorites') || '[]');
            const f = list[parseInt(idx)];
            const name = window.prompt('Nytt namn f√∂r favoriten:', f.name);
            if (name && name.trim().length) {
                f.name = name.trim();
                list[parseInt(idx)] = f;
                localStorage.setItem('snowFavorites', JSON.stringify(list));
                populateFavorites();
            }
        });

        document.getElementById('delFavBtn').addEventListener('click', () => {
            const sel = document.getElementById('favoritesSelect');
            const idx = sel.value;
            if (!idx) return alert('V√§lj en favorit att ta bort');
            if (!confirm('Ta bort vald favorit?')) return;
            const list = JSON.parse(localStorage.getItem('snowFavorites') || '[]');
            list.splice(parseInt(idx), 1);
            localStorage.setItem('snowFavorites', JSON.stringify(list));
            populateFavorites();
        });

        // Map search (Nominatim)
        let searchTimeout = null;
        const searchInput = document.getElementById('mapSearch');
        const searchBtn = document.getElementById('mapSearchBtn');
        const resultsEl = document.getElementById('searchResults');

        async function performSearch(q) {
            if (!q || q.trim().length < 2) { resultsEl.style.display = 'none'; resultsEl.innerHTML = ''; return; }
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = '<div style="color:#94a3b8;padding:8px">S√∂ker‚Ä¶</div>';
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=8&q=${encodeURIComponent(q)}`);
                const json = await res.json();
                resultsEl.innerHTML = '';
                if (!json || json.length === 0) {
                    resultsEl.innerHTML = '<div style="color:#94a3b8;padding:8px">Inga tr√§ffar</div>';
                    return;
                }
                json.forEach((r, i) => {
                    const div = document.createElement('div');
                    div.className = 'search-result';
                    div.innerText = r.display_name;
                    div.onclick = () => {
                        const lat = parseFloat(r.lat); const lon = parseFloat(r.lon);
                        if (!mapInstance) openMap();
                        markerInstance.setLatLng([lat, lon]);
                        mapInstance.setView([lat, lon], 13);
                        currentLat = lat; currentLon = lon; currentName = r.display_name.split(',')[0];
                        localStorage.setItem('snowLat', currentLat); localStorage.setItem('snowLon', currentLon); localStorage.setItem('snowName', currentName);
                        updateLocationText();
                        // leave modal open so user can Save Plats to save as favorite
                        resultsEl.style.display = 'none';
                    };
                    resultsEl.appendChild(div);
                });
            } catch (err) {
                resultsEl.innerHTML = '<div style="color:#fecaca;padding:8px">Fel vid s√∂kning</div>';
            }
        }

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const q = e.target.value;
            searchTimeout = setTimeout(() => performSearch(q), 300);
        });

        searchBtn.addEventListener('click', () => performSearch(searchInput.value));

        // Initialize favorites on load (ensure default is present first)
        ensureDefaultFavorite();
        populateFavorites();

        function updateLocationText() { document.getElementById('locationDisplay').innerText = `${currentName} ‚Äî Koord: ${currentLat.toFixed(3)}, ${currentLon.toFixed(3)}`; }

        // LOADING UI
        function showLoading(show) {
            const el = document.getElementById('loadingOverlay');
            el.style.display = show ? 'flex' : 'none';
            document.getElementById('errorMsg').innerText = '';
        }

        // WEATHER DATA (Open-Meteo)
        async function fetchData() {
            showLoading(true);
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&forecast_days=10`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const json = await response.json();
                weatherData = json.hourly.time.map((time, index) => {
                    const temp = json.hourly.temperature_2m[index];
                    const hum = json.hourly.relative_humidity_2m[index];
                    const wind = json.hourly.wind_speed_10m[index];
                    const dir = json.hourly.wind_direction_10m[index];
                    const wetBulb = calculateWetBulb(temp, hum);
                    return { x: time, temp, wetBulb, wind, dir };
                });

                if (chartInstance) chartInstance.destroy();
                createChart();
            } catch (error) {
                console.error('Fel vid h√§mtning:', error);
                document.getElementById('errorMsg').innerText = 'Fel: Kunde inte h√§mta v√§derdata.';
                weatherData = [];
                if (chartInstance) chartInstance.destroy();
            } finally {
                showLoading(false);
            }
        }

        // WET BULB
        function calculateWetBulb(T, Rh) {
            return T * Math.atan(0.151977 * Math.pow(Rh + 8.313659, 0.5)) + Math.atan(T + Rh) - Math.atan(Rh - 1.676331) + 0.00391838 * Math.pow(Rh, 1.5) * Math.atan(0.023101 * Rh) - 4.686035;
        }

        // CREATE CHART
        function createChart() {
            const ctx = document.getElementById('snowChart').getContext('2d');
            const getDir = (d) => ['N','N√ñ','√ñ','S√ñ','S','SV','V','NV'][Math.round(d/45)%8];
            // Wind arrows plugin (draw small arrows at top showing wind direction)
            const windPlugin = {
                id: 'windArrows',
                afterDraw: function(chart) {
                    if (!weatherData || weatherData.length === 0) return;
                    const ctx = chart.ctx;
                    const xScale = chart.scales.x;
                    const left = chart.chartArea.left;
                    const right = chart.chartArea.right;
                    const top = chart.chartArea.top + 8;
                    // limit number of arrows to ~40
                    const step = Math.max(1, Math.ceil(weatherData.length / 40));
                    for (let i = 0; i < weatherData.length; i += step) {
                        const d = weatherData[i];
                        const x = xScale.getPixelForValue(new Date(d.x));
                        if (x < left - 10 || x > right + 10) continue;
                        drawArrow(ctx, x, top, d.dir);
                    }
                }
            };

            function drawArrow(ctx, x, y, deg) {
                ctx.save();
                ctx.translate(x, y);
                // rotate: Chart canvas default 0 rad is to the right; wind dir is degrees from north (clockwise)
                // convert so 0deg (N) points up: rotate by (deg) degrees clockwise then subtract 90deg
                const rad = (deg - 90) * Math.PI / 180;
                ctx.rotate(rad);
                ctx.beginPath();
                ctx.moveTo(-6, -4);
                ctx.lineTo(8, 0);
                ctx.lineTo(-6, 4);
                ctx.closePath();
                ctx.fillStyle = 'rgba(203, 213, 225, 0.9)';
                ctx.fill();
                ctx.restore();
            }

            // Register plugin (safe to call multiple times)
            try { Chart.register(windPlugin); } catch (e) { /* ignore if already registered */ }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'V√•ttemperatur', data: weatherData.map(d => ({x: d.x, y: d.wetBulb})), borderColor: '#38bdf8', borderWidth: 3, pointRadius: 0, pointHitRadius: 20, tension: 0.3, yAxisID: 'y' },
                        { label: 'Lufttemperatur', data: weatherData.map(d => ({x: d.x, y: d.temp})), borderColor: '#94a3b8', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, tension: 0.3, yAxisID: 'y' },
                        { label: 'Vind (m/s)', data: weatherData.map(d => ({x: d.x, y: d.wind})), borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', borderWidth: 1, fill: true, pointRadius: 0, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toFixed(1);
                                    if(context.dataset.label === 'Vind (m/s)') {
                                        label += ` m/s (${getDir(weatherData[context.dataIndex].dir)})`;
                                    }
                                    if(context.dataset.label.includes('temperatur')) label += '¬∞C';
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                hotZone: { type: 'box', yMin: -2.5, yMax: 50, backgroundColor: 'rgba(239, 68, 68, 0.2)', borderWidth: 0, drawTime: 'beforeDatasetsDraw' },
                                coldZone: { type: 'box', yMin: -50, yMax: -2.5, backgroundColor: 'rgba(14, 165, 233, 0.2)', borderWidth: 0, drawTime: 'beforeDatasetsDraw' },
                                limitLine: { type: 'line', yMin: -2.5, yMax: -2.5, borderColor: 'rgba(255,255,255,0.3)', borderWidth: 1, label: { display: true, content: '-2.5¬∞C', color: 'rgba(255,255,255,0.5)', position: 'start' } }
                            }
                        },
                        zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' }, limits: { x: { min: 'original', max: 'original' } } }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'EEE d MMM' } }, grid: { color: '#334155' }, ticks: { color: '#cbd5e1' } },
                        y: { type: 'linear', display: true, position: 'left', grid: { color: '#334155' }, ticks: { color: '#cbd5e1' } },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#fbbf24' }, min: 0 }
                    }
                }
            });
            // √Öterst√§ll zoom-knappar visuellt
            // default to 10 days view
            const defaultBtn = document.querySelector('.time-btn:last-child');
            setRange(240, defaultBtn);
        }

        // TIDSSKALA
        function setRange(hours, btn) {
            if(!chartInstance) return;
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            if (btn && btn.classList) btn.classList.add('active');

            const now = new Date();
            const future = new Date(now.getTime() + hours * 60 * 60 * 1000);
            chartInstance.options.scales.x.min = now.getTime();
            chartInstance.options.scales.x.max = future.getTime();
            chartInstance.update();
        }

        // Start app
        fetchData();
        if(!localStorage.getItem('snowLat')) setTimeout(openMap, 500);
    </script>
</body>
</html>

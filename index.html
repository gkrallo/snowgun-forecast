<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sn√∂prognos Pro+</title>
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #1e293b; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { font-size: 1.1rem; margin: 0; color: #e2e8f0; }
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; padding: 0; }
        
        /* Controls & Favs */
        .controls { display: flex; justify-content: center; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .fav-controls { display:flex; align-items:center; gap:8px; margin-bottom: 10px; flex-wrap: wrap; }
        
        button.time-btn { background-color: #334155; border: 1px solid #475569; color: white; padding: 6px 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s; font-size: 0.8rem; }
        button.time-btn:active, button.time-btn.active { background-color: #3b82f6; border-color: #3b82f6; }
        
        /* Chart area */
        .chart-container { flex-grow: 1; position: relative; min-height: 250px; background: #0f172a; border-radius: 12px; padding: 10px; border: 1px solid #334155; overflow: hidden; }
        .legend { font-size: 0.75rem; text-align: center; margin-top: 5px; color: #94a3b8; }
        
        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #1e293b; width: 100%; max-width: 600px; max-height: 95%; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #475569; position: relative; }
        .modal-header { padding: 15px; text-align: center; background: #0f172a; border-bottom: 1px solid #334155; }
        .modal-body { padding: 20px; overflow-y: auto; color: #cbd5e1; line-height: 1.6; }
        .modal-footer { padding: 15px; display: flex; gap: 10px; justify-content: center; background: #0f172a; border-top: 1px solid #334155; }
        
        /* Info Content Styles */
        .info-section { margin-bottom: 25px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .info-section:last-child { border-bottom: none; }
        .info-title { font-size: 1.1rem; color: #38bdf8; margin: 0 0 10px 0; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .highlight-box { background: rgba(56, 189, 248, 0.1); border-left: 4px solid #38bdf8; padding: 10px; margin: 10px 0; border-radius: 4px; }
        
        /* Calculator Specific Styles */
        .calc-group { margin-bottom: 15px; background: #0f172a; padding: 12px; border-radius: 8px; border: 1px solid #334155; }
        .calc-label { display: block; font-size: 0.85rem; color: #94a3b8; margin-bottom: 6px; font-weight: bold; }
        .calc-input { width: 100%; background: #1e293b; border: 1px solid #475569; color: #fff; padding: 8px; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        /* Prediction Summary */
        .prediction-box { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; gap: 10px; }
        .pred-item { flex: 1; text-align: center; }
        .pred-label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; }
        .pred-val { font-weight: bold; font-size: 0.95rem; color: #fff; }
        .text-green { color: #86efac; }
        .text-red { color: #fca5a5; }

        .calc-chart-container { height: 200px; width: 100%; margin-top: 15px; border-top: 1px solid #334155; padding-top: 15px; }

        /* Slider Styling */
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #38bdf8; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #94a3b8; }

        /* Map specific */
        #map { flex-grow: 1; width: 100%; min-height: 300px; }
        
        /* Buttons */
        .save-btn { background-color: #22c55e; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .cancel-btn { background-color: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .icon-btn { background:#0f172a; border:1px solid #334155; color:#e2e8f0; padding:6px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
        .icon-btn:hover { background:#1e293b; border-color:#94a3b8; }
        .calc-btn { background:#0ea5e9; border:none; color:white; padding:6px 10px; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px; font-size:0.9rem;}

        /* Loading & Error */
        #loadingOverlay { display: none; position: absolute; inset: 0; background: rgba(2,6,23,0.7); z-index: 200; align-items: center; justify-content: center; border-radius: 12px; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error { color: #fca5a5; font-size: 0.9rem; text-align: center; margin-top: 5px; min-height: 20px; }

        /* Search & Select */
        .search-result { padding:10px; border-bottom:1px solid #334155; cursor:pointer; }
        .search-result:hover { background:#334155; }
        select { background:#0f172a; color:#e2e8f0; border:1px solid #334155; padding:6px; border-radius:6px; max-width: 150px; cursor: pointer;}
        select:hover { border-color: #94a3b8; }
    </style>
</head>
<body>

    <div class="header">
        <h1>‚ùÑÔ∏è Sn√∂prognos</h1>
        <div style="display:flex; gap:10px;">
            <button class="calc-btn" onclick="openCalc()">üßÆ Kalkylator</button>
            <button class="settings-btn" onclick="openInfo()" title="Info">‚ÑπÔ∏è</button>
            <button class="settings-btn" onclick="openMap()" title="Karta">üìç</button>
        </div>
    </div>

    <div class="fav-controls">
        <div style="flex-grow:1; overflow:hidden;">
            <span id="locationDisplay" style="font-size:0.9rem; color:#cbd5e1; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Laddar...</span>
        </div>
        <select id="favoritesSelect"></select>
        <button id="editFavBtn" class="icon-btn" title="Redigera namn">‚úèÔ∏è</button>
        <button id="delFavBtn" class="icon-btn" title="Ta bort">üóëÔ∏è</button>
    </div>

    <div class="controls">
        <button onclick="setRange(12, this)" class="time-btn">12h</button>
        <button onclick="setRange(24, this)" class="time-btn">24h</button>
        <button onclick="setRange(72, this)" class="time-btn">3 Dygn</button>
        <button onclick="setRange(120, this)" class="time-btn">5 Dygn</button>
        <button onclick="setRange(240, this)" class="time-btn active">10 Dygn</button>
        <button onclick="resetZoom()" class="time-btn" style="border-color:#fbbf24; color:#fbbf24;">Reset Zoom</button>
    </div>

    <div class="chart-container">
        <div id="loadingOverlay">
            <div class="spinner"></div><div style="color:#e2e8f0;">H√§mtar v√§derdata...</div>
        </div>
        <canvas id="snowChart"></canvas>
    </div>
    <div class="legend">Zooma: Nyp / Scrolla ‚Ä¢ Panorera: Dra ‚Ä¢ R√∂d: Varmt ‚Ä¢ Bl√•: Sn√∂ (Wet-bulb &lt; -2.5)</div>
    <div id="errorMsg" class="error"></div>

    <div id="calcModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Produktionskalkylator</h3></div>
            <div class="modal-body">
                
                <div class="calc-group">
                    <label class="calc-label">üå°Ô∏è Vattentemperatur (¬∞C)</label>
                    <input type="number" id="waterTempInput" class="calc-input" value="1.5" step="0.1" oninput="updateCalc()">
                </div>

                <div class="calc-group">
                    <label class="calc-label">‚ùÑÔ∏è √ñnskad Kvalitet (1=Torr, 10=Bl√∂t)</label>
                    <input type="range" id="qualityInput" min="1" max="10" value="5" step="1" oninput="updateCalc()">
                    <div class="slider-labels">
                        <span>Puder (1)</span>
                        <span id="qualityValue" style="color:#38bdf8; font-weight:bold;">5</span>
                        <span>Bas (10)</span>
                    </div>
                </div>

                <div class="prediction-box">
                    <div class="pred-item">
                        <span class="pred-label">Start Fl√§kt</span>
                        <span id="predFanTime" class="pred-val">--:--</span>
                    </div>
                    <div class="pred-item" style="border-left:1px solid #334155;">
                        <span class="pred-label">Start Lans</span>
                        <span id="predLanceTime" class="pred-val">--:--</span>
                    </div>
                </div>

                <div style="text-align:center; font-size:0.8rem; color:#94a3b8;">
                    Trendkurva (Kommande 48h)
                </div>

                <div class="calc-chart-container">
                    <canvas id="calcChart"></canvas>
                </div>

            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeCalc()" style="background:#334155;">St√§ng</button>
            </div>
        </div>
    </div>

    <div id="mapModal" class="modal-overlay">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <h3>V√§lj Plats</h3>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input id="mapSearch" placeholder="S√∂k plats..." style="flex:1; background:#0f172a; color:#fff; border:1px solid #334155; padding:8px; border-radius:6px;">
                    <button id="mapSearchBtn" class="icon-btn">üîç</button>
                </div>
                <div id="searchResults" style="display:none; max-height:150px; overflow-y:auto; background:#1e293b; border:1px solid #334155; margin-top:5px; text-align:left;"></div>
            </div>
            <div id="map"></div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeMap()">Avbryt</button>
                <button class="save-btn" onclick="saveLocation()">Spara Plats</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Information & Teori</h3></div>
            <div class="modal-body">
                <div class="info-section">
                    <h4 class="info-title">üì± S√• fungerar appen</h4>
                    <p>Grafen visar <strong>V√•ttemperatur (Wet-bulb)</strong> vilket √§r det viktigaste m√•ttet f√∂r sn√∂tillverkning. </p>
                </div>
                <div class="info-section">
                    <h4 class="info-title">üí® Kalkylatorn</h4>
                    <p>Kalkylatorn anv√§nder <strong>framtida prognosdata</strong> f√∂r att r√§kna ut n√§r du kan starta.</p>
                    <p><strong>Vattentemp:</strong> Varmt vatten straffar systemet och kr√§ver kallare luft.</p>
                    <p><strong>Kvalitet:</strong> Att g√∂ra torr sn√∂ (l√•gt v√§rde) kr√§ver mycket kallare temperaturer √§n att g√∂ra bl√∂t "bassn√∂".</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeInfo()" style="background:#334155;">St√§ng</button>
            </div>
        </div>
    </div>

    <script>
        // --- INST√ÑLLNINGAR & STATE ---
        let currentLat = parseFloat(localStorage.getItem('snowLat')) || 58.503; 
        let currentLon = parseFloat(localStorage.getItem('snowLon')) || 13.088; 
        let currentName = localStorage.getItem('snowName') || 'Sparbankssp√•ret';
        
        let chartInstance = null;
        let calcChartInstance = null; // Ny graf-instans f√∂r kalkylatorn
        let mapInstance = null;
        let markerInstance = null;
        let weatherData = []; 
        let weatherDataDetailed = []; 
        let favorites = JSON.parse(localStorage.getItem('snowFavorites') || '[]');

        // Start
        init();

        function init() {
            ensureDefaultFavorite();
            populateFavorites();
            updateLocationText();
            fetchData();
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            showLoading(true);
            document.getElementById('errorMsg').innerText = "";
            
            const urlHourly = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&wind_speed_unit=ms&forecast_days=10&models=best_match`;
            const url15min = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&minutely_15=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&wind_speed_unit=ms&forecast_days=2&models=best_match`;

            try {
                const [resHourly, res15] = await Promise.all([fetch(urlHourly), fetch(url15min)]);
                
                if(!resHourly.ok) throw new Error("Kunde inte h√§mta v√§derdata");
                const jsonH = await resHourly.json();
                
                weatherData = jsonH.hourly.time.map((t, i) => ({
                    x: new Date(t).getTime(),
                    temp: jsonH.hourly.temperature_2m[i],
                    hum: jsonH.hourly.relative_humidity_2m[i],
                    wind: jsonH.hourly.wind_speed_10m[i],
                    dir: jsonH.hourly.wind_direction_10m[i],
                    wetBulb: calculateWetBulb(jsonH.hourly.temperature_2m[i], jsonH.hourly.relative_humidity_2m[i])
                }));

                if(res15.ok) {
                    const json15 = await res15.json();
                    if(json15.minutely_15) {
                        weatherDataDetailed = json15.minutely_15.time.map((t, i) => ({
                            x: new Date(t).getTime(),
                            temp: json15.minutely_15.temperature_2m[i],
                            hum: json15.minutely_15.relative_humidity_2m[i],
                            wind: json15.minutely_15.wind_speed_10m[i],
                            dir: json15.minutely_15.wind_direction_10m[i],
                            wetBulb: calculateWetBulb(json15.minutely_15.temperature_2m[i], json15.minutely_15.relative_humidity_2m[i])
                        }));
                    }
                }

                drawChart();

            } catch (err) {
                console.error(err);
                document.getElementById('errorMsg').innerText = "Fel: Kunde inte h√§mta data. Kontrollera n√§tverk.";
            } finally {
                showLoading(false);
            }
        }

        function calculateWetBulb(T, Rh) {
            return T * Math.atan(0.151977 * Math.pow(Rh + 8.313659, 0.5)) + Math.atan(T + Rh) - Math.atan(Rh - 1.676331) + 0.00391838 * Math.pow(Rh, 1.5) * Math.atan(0.023101 * Rh) - 4.686035;
        }

        // --- MAIN CHART ---
        function drawChart() {
            const ctx = document.getElementById('snowChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const windArrowPlugin = {
                id: 'windArrows',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    if(chart.scales.x.max - chart.scales.x.min > 86400000 * 3) return;

                    ctx.save();
                    const dataPoints = chart.data.datasets[2].data;
                    let step = 1;
                    const visiblePoints = dataPoints.filter(dp => dp.x >= chart.scales.x.min && dp.x <= chart.scales.x.max).length;
                    if(visiblePoints > 30) step = Math.ceil(visiblePoints / 30);
                    dataPoints.forEach((dp, i) => {
                        if (i % step !== 0) return;
                        if (dp.x < chart.scales.x.min || dp.x > chart.scales.x.max) return;
                        const x = chart.scales.x.getPixelForValue(dp.x);
                        const y = chart.chartArea.top + 15;
                        drawArrow(ctx, x, y, dp.dir);
                    });
                    ctx.restore();
                }
            };

            const verticalHoverLine = {
                id: 'verticalHoverLine',
                afterDraw: (chart) => {
                    if (chart.tooltip?._active?.length) {
                        const x = chart.tooltip._active[0].element.x;
                        const yAxis = chart.scales.y;
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, yAxis.top);
                        ctx.lineTo(x, yAxis.bottom);
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            };

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'V√•ttemperatur', data: weatherData.map(d => ({x: d.x, y: d.wetBulb})), borderColor: '#38bdf8', borderWidth: 3, pointRadius: 0, tension: 0.4, yAxisID: 'y' },
                        { label: 'Lufttemp', data: weatherData.map(d => ({x: d.x, y: d.temp})), borderColor: '#94a3b8', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, tension: 0.4, yAxisID: 'y' },
                        { label: 'Vind (m/s)', data: weatherData.map(d => ({x: d.x, y: d.wind, dir: d.dir})), borderColor: 'rgba(251, 191, 36, 0.5)', backgroundColor: 'rgba(251, 191, 36, 0.1)', fill: true, borderWidth: 1, pointRadius: 0, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    scales: {
                        x: { type: 'time', time: { minUnit: 'hour', parser: 'yyyy-MM-dd HH:mm', tooltipFormat: 'd MMM HH:mm', displayFormats: { hour: 'HH:mm', day: 'd MMM' } }, grid: { color: '#334155' }, ticks: { color: '#cbd5e1' } },
                        y: { display: true, position: 'left', grid: { color: '#334155' }, ticks: { color: '#cbd5e1' }, min: -30, max: 20 },
                        y1: { display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#fbbf24' }, min: 0, max: 30 }
                    },
                    plugins: { 
                        legend: { display: false }, 
                        // --- H√ÑR √ÑR MARKERINGEN √ÖTERST√ÑLLD ---
                        annotation: {
                            annotations: {
                                box1: { type: 'box', yMin: -30, yMax: -2.5, backgroundColor: 'rgba(14, 165, 233, 0.15)', borderWidth: 0, yScaleID: 'y' },
                                line1: { type: 'line', yMin: -2.5, yMax: -2.5, borderColor: 'rgba(14, 165, 233, 0.5)', borderWidth: 1, borderDash: [2, 2], label: { display: true, content: '-2.5¬∞C', position: 'start', backgroundColor: 'transparent', color: '#38bdf8', font: {size:10} } }
                            }
                        },
                        // ------------------------------------
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x', onZoomComplete: updateDetailLevel } } 
                    }
                },
                plugins: [windArrowPlugin, verticalHoverLine]
            });
            setRange(240, document.querySelector('.time-btn.active'));
        }

        function drawArrow(ctx, x, y, deg) {
            ctx.save(); ctx.translate(x, y); ctx.rotate((deg * Math.PI) / 180);
            ctx.beginPath(); ctx.moveTo(0, -6); ctx.lineTo(-4, 4); ctx.lineTo(0, 2); ctx.lineTo(4, 4); ctx.closePath();
            ctx.fillStyle = '#cbd5e1'; ctx.fill(); ctx.restore();
        }

        function updateDetailLevel({chart}) {
            const min = chart.scales.x.min;
            const max = chart.scales.x.max;
            const diffHours = (max - min) / (1000 * 60 * 60);
            let source = weatherData; 
            if (diffHours < 36 && weatherDataDetailed.length > 0) {
                 const detailStart = weatherDataDetailed[0].x;
                 const detailEnd = weatherDataDetailed[weatherDataDetailed.length-1].x;
                 if(min >= detailStart && max <= detailEnd) source = weatherDataDetailed;
            }
            chart.data.datasets[0].data = source.map(d => ({x: d.x, y: d.wetBulb}));
            chart.data.datasets[1].data = source.map(d => ({x: d.x, y: d.temp}));
            chart.data.datasets[2].data = source.map(d => ({x: d.x, y: d.wind, dir: d.dir}));
            chart.update(); 
        }

        function setRange(hours, btn) {
            if(!chartInstance) return;
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            const now = Date.now();
            const future = now + (hours * 60 * 60 * 1000);
            chartInstance.zoomScale('x', {min: now, max: future}, 'default');
            updateDetailLevel({chart: chartInstance});
        }

        function resetZoom() { setRange(240, document.querySelector('.time-btn:nth-last-child(2)')); }
        function getWindDir(d) { const dirs = ['N','N√ñ','√ñ','S√ñ','S','SV','V','NV']; return dirs[Math.round(d/45)%8]; }
        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function updateLocationText() { document.getElementById('locationDisplay').innerText = `${currentName} (${currentLat.toFixed(3)}, ${currentLon.toFixed(3)})`; }

        // --- CALC LOGIC & PREDICTION ---
        function openCalc() {
            document.getElementById('calcModal').style.display = 'flex';
            updateCalc();
        }
        function closeCalc() { document.getElementById('calcModal').style.display = 'none'; }

        function updateCalc() {
            const waterTemp = parseFloat(document.getElementById('waterTempInput').value) || 0;
            const quality = parseInt(document.getElementById('qualityInput').value);
            document.getElementById('qualityValue').innerText = quality;

            // Straff och tr√∂skelv√§rden
            const waterPenalty = Math.max(0, waterTemp * 0.5); 
            const qualityPenalty = (10 - quality) * 0.4;
            
            const fanThreshold = -2.0 - qualityPenalty;
            const lanceThreshold = -4.0 - qualityPenalty;

            // Anv√§nd detaljdata om m√∂jligt, annars timdata. Ta bara framtida punkter.
            const now = Date.now();
            let ds = (weatherDataDetailed.length > 0) ? weatherDataDetailed : weatherData;
            // Filtrera data: Fr√•n nu och 48h fram√•t
            const futureData = ds.filter(d => d.x >= now && d.x <= now + (48 * 3600 * 1000));

            // R√§kna ut kapacitet f√∂r varje tidpunkt
            const fanData = [];
            const lanceData = [];
            let nextFanStart = null;
            let nextLanceStart = null;

            futureData.forEach(pt => {
                const effectiveWB = pt.wetBulb + waterPenalty;
                
                // Kapacitetsformel (0-100%)
                // Om kallare √§n threshold, √∂ka kapacitet.
                // Vi antar att vid exakt threshold √§r det "marginal" (ca 10-20%).
                // Vid 5 grader under threshold √§r det 100%.
                
                // FL√ÑKT
                let fanCap = 0;
                if(effectiveWB <= fanThreshold) {
                    const diff = fanThreshold - effectiveWB;
                    fanCap = Math.min(100, 20 + (diff * 16)); // Aggressiv kurva
                    if(!nextFanStart) nextFanStart = pt.x;
                }
                fanData.push({x: pt.x, y: fanCap});

                // LANS
                let lanceCap = 0;
                if(effectiveWB <= lanceThreshold) {
                    const diff = lanceThreshold - effectiveWB;
                    lanceCap = Math.min(100, 20 + (diff * 16));
                    if(!nextLanceStart) nextLanceStart = pt.x;
                }
                lanceData.push({x: pt.x, y: lanceCap});
            });

            // Uppdatera Text-display f√∂r Starttider
            updatePredictionText('predFanTime', nextFanStart);
            updatePredictionText('predLanceTime', nextLanceStart);

            // Rita/Uppdatera Grafen
            drawCalcChart(fanData, lanceData);
        }

        function updatePredictionText(elId, time) {
            const el = document.getElementById(elId);
            if(!time) {
                el.innerText = "Ingen start (48h)";
                el.className = "pred-val text-red";
            } else {
                const d = new Date(time);
                // Om det √§r inom 30 min, skriv "NU"
                if (time - Date.now() < 30 * 60000) {
                     el.innerText = "K√ñR NU!";
                     el.className = "pred-val text-green";
                } else {
                    // Formatera snyggt: "Idag 22:00" eller "Imorgon 04:00"
                    const today = new Date().getDate();
                    const targetDay = d.getDate();
                    const prefix = (today === targetDay) ? "Idag" : "Imorgon";
                    const timeStr = d.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'});
                    el.innerText = `${prefix} ${timeStr}`;
                    el.className = "pred-val text-green";
                }
            }
        }

        function drawCalcChart(fanData, lanceData) {
            const ctx = document.getElementById('calcChart').getContext('2d');
            
            if (calcChartInstance) calcChartInstance.destroy();

            calcChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Fl√§kt Kapacitet',
                            data: fanData,
                            borderColor: '#86efac', // Green
                            backgroundColor: 'rgba(134, 239, 172, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Lans Kapacitet',
                            data: lanceData,
                            borderColor: '#60a5fa', // Blue
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, labels: { color: '#94a3b8', font: {size: 10}, boxWidth: 10 } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.y.toFixed(0)}%`
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            grid: { display: false },
                            ticks: { color: '#64748b', maxTicksLimit: 6 }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#334155' },
                            ticks: { color: '#64748b', callback: (v) => v + '%' }
                        }
                    }
                }
            });
        }

        // --- MAP & FAVORITES ---
        function openMap() {
            document.getElementById('mapModal').style.display = 'flex';
            if(!mapInstance) {
                mapInstance = L.map('map').setView([currentLat, currentLon], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(mapInstance);
                markerInstance = L.marker([currentLat, currentLon], {draggable: true}).addTo(mapInstance);
                mapInstance.on('click', e => markerInstance.setLatLng(e.latlng));
            } else {
                setTimeout(() => { mapInstance.invalidateSize(); }, 100);
                mapInstance.setView([currentLat, currentLon], 10);
                markerInstance.setLatLng([currentLat, currentLon]);
            }
        }
        function closeMap() { document.getElementById('mapModal').style.display = 'none'; }
        
        function saveLocation() {
            const pos = markerInstance.getLatLng();
            currentLat = pos.lat;
            currentLon = pos.lng;
            if(confirm("Vill du spara som ny favorit?")) {
                const name = prompt("Namn p√• plats:", currentName) || "Ok√§nd plats";
                saveFavoriteItem(name, currentLat, currentLon);
                currentName = name;
            } else { currentName = "Vald plats"; }
            localStorage.setItem('snowLat', currentLat); localStorage.setItem('snowLon', currentLon); localStorage.setItem('snowName', currentName);
            updateLocationText(); closeMap(); fetchData();
        }

        function ensureDefaultFavorite() {
            if(!favorites.some(f => f.name === 'Sparbankssp√•ret')) {
                favorites.unshift({name: 'Sparbankssp√•ret', lat: 58.503, lon: 13.088});
                localStorage.setItem('snowFavorites', JSON.stringify(favorites));
            }
        }
        function populateFavorites() {
            const sel = document.getElementById('favoritesSelect');
            sel.innerHTML = '<option value="">-- Favoriter --</option>';
            favorites.forEach((f, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.text = f.name;
                if(f.name === currentName) opt.selected = true;
                sel.appendChild(opt);
            });
        }
        function saveFavoriteItem(name, lat, lon) {
            const existing = favorites.findIndex(f => f.name === name);
            if(existing >= 0) favorites[existing] = {name, lat, lon};
            else favorites.push({name, lat, lon});
            localStorage.setItem('snowFavorites', JSON.stringify(favorites));
            populateFavorites();
        }

        document.getElementById('favoritesSelect').onchange = (e) => {
            const idx = e.target.value; if(idx === "") return;
            const fav = favorites[idx];
            currentLat = fav.lat; currentLon = fav.lon; currentName = fav.name;
            localStorage.setItem('snowLat', currentLat); localStorage.setItem('snowLon', currentLon); localStorage.setItem('snowName', currentName);
            updateLocationText(); fetchData();
        };

        document.getElementById('delFavBtn').onclick = () => {
            const idx = document.getElementById('favoritesSelect').value;
            if(idx === "") return alert("V√§lj en favorit att ta bort");
            if(confirm("√Ñr du s√§ker?")) {
                favorites.splice(idx, 1);
                localStorage.setItem('snowFavorites', JSON.stringify(favorites));
                if(favorites[idx]?.name === currentName) currentName = "Vald plats"; 
                populateFavorites();
            }
        };

        document.getElementById('editFavBtn').onclick = () => {
             const idx = document.getElementById('favoritesSelect').value;
             if(idx === "") return alert("V√§lj en favorit");
             const newName = prompt("Nytt namn:", favorites[idx].name);
             if(newName) {
                 favorites[idx].name = newName; localStorage.setItem('snowFavorites', JSON.stringify(favorites));
                 currentName = newName; populateFavorites(); updateLocationText();
             }
        };

        document.getElementById('mapSearchBtn').onclick = async () => {
            const q = document.getElementById('mapSearch').value;
            const resDiv = document.getElementById('searchResults');
            if(!q) return;
            resDiv.style.display = 'block'; resDiv.innerHTML = '<div style="padding:10px; color:#94a3b8;">S√∂ker...</div>';
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                const data = await r.json();
                resDiv.innerHTML = '';
                if(data.length === 0) resDiv.innerHTML = '<div style="padding:10px;">Inga tr√§ffar</div>';
                data.forEach(place => {
                    const d = document.createElement('div'); d.className = 'search-result';
                    d.innerText = place.display_name.split(',')[0];
                    d.onclick = () => {
                        const lat = parseFloat(place.lat); const lon = parseFloat(place.lon);
                        markerInstance.setLatLng([lat, lon]); mapInstance.setView([lat, lon], 12);
                        resDiv.style.display = 'none';
                    };
                    resDiv.appendChild(d);
                });
            } catch(e) { resDiv.innerHTML = 'Fel vid s√∂kning'; }
        };

        function openInfo() { document.getElementById('infoModal').style.display = 'flex'; }
        function closeInfo() { document.getElementById('infoModal').style.display = 'none'; }
    </script>
</body>
</html>